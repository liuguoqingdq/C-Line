<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C++ Thunk æœºåˆ¶æ·±åº¦å¯è§†åŒ–</title>
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #1e1e2e; color: #e0e0e0; }
        
        /* å†…å­˜å—æ ·å¼ */
        .memory-cell {
            transition: all 0.3s ease;
            position: relative;
        }
        .memory-cell:hover { transform: scale(1.02); z-index: 10; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        
        /* è¿çº¿å±‚ */
        #svg-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 20;
        }

        /* åŠ¨æ€æŒ‡é’ˆæ ·å¼ */
        #active-pointer {
            transition: top 1.0s cubic-bezier(0.25, 1, 0.5, 1), left 0.5s, opacity 0.3s;
            z-index: 50;
        }

        /* Thunk ä»£ç çª—å£ */
        #thunk-window {
            opacity: 0;
            transform: scale(0.9);
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        #thunk-window.active {
            opacity: 1;
            transform: scale(1);
        }

        /* åŠ¨ç”»ç±» */
        .highlight-line { background-color: #3b82f6 !important; color: white !important; }
        .highlight-flash { animation: flash 1s infinite; border-color: #f59e0b !important; background-color: #451a03 !important; }
        
        @keyframes flash {
            0% { opacity: 1; }
            50% { opacity: 0.6; }
            100% { opacity: 1; }
        }

        .target-marker {
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }
        @keyframes popIn {
            0% { opacity: 0; transform: translateX(20px); }
            100% { opacity: 1; transform: translateX(0); }
        }

        /* ä»£ç é«˜äº® */
        .code-keyword { color: #c678dd; }
        .code-type { color: #e5c07b; }
        .code-func { color: #61afef; }
        .code-comment { color: #7f848e; font-style: italic; }
    </style>
</head>
<body class="overflow-x-hidden h-screen flex flex-col">

    <!-- é¡¶éƒ¨æ§åˆ¶æ  -->
    <div class="fixed top-0 left-0 w-full bg-slate-900 border-b border-slate-700 p-4 shadow-lg z-50 flex justify-between items-center">
        <div>
            <h1 class="text-xl font-bold text-blue-400">C++ Thunk (ä¸­è½¬å‡½æ•°) æœºåˆ¶æ·±åº¦è§£æ</h1>
            <p class="text-xs text-gray-400 font-mono">åœºæ™¯ï¼šBaseX è§†è§’è°ƒç”¨è™šå‡½æ•° -> è§¦å‘ Thunk -> è°ƒæ•´ this -> è·³è½¬å®ç°</p>
        </div>
        <div class="flex gap-3">
            <button onclick="resetDemo()" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded transition text-sm">é‡ç½®</button>
            <button onclick="nextStep()" id="btn-next" class="px-6 py-2 bg-blue-600 hover:bg-blue-500 rounded font-bold shadow-lg transition flex items-center gap-2 text-white">
                ä¸‹ä¸€æ­¥ <span id="step-desc" class="text-xs font-normal opacity-80">(å¼€å§‹æ¼”ç¤º)</span>
            </button>
        </div>
    </div>

    <div class="flex-1 container mx-auto mt-24 px-4 pb-10 relative grid grid-cols-12 gap-6">
        <svg id="svg-layer"></svg>

        <!-- å·¦ä¾§ï¼šä»£ç åŒº -->
        <div class="col-span-3 space-y-4">
            <div class="bg-slate-800 rounded-lg p-4 text-xs text-gray-300 font-mono shadow-xl border border-slate-700">
                <div class="mb-2 text-xs text-blue-400 font-bold border-b border-slate-600 pb-1">C++ æºç </div>
<pre>
<span class="code-keyword">class</span> <span class="code-type">Base1</span> { ... };

<span class="code-keyword">class</span> <span class="code-type">Base2</span> {
  int b2;
  <span id="code-f3" class="transition bg-transparent px-1 rounded">virtual void f();</span>
};

<span class="code-keyword">class</span> <span class="code-type">Derived</span> : <span class="code-keyword">public</span> Base1, <span class="code-keyword">public</span> Base2 {
  int d;
  <span id="code-f3-impl" class="transition bg-transparent px-1 rounded">void f() override;</span>
};

// Main
Derived obj;
<span id="code-cast" class="transition bg-transparent px-1 rounded">Base2* ptr = &obj;</span>
<span id="code-call" class="transition bg-transparent px-1 rounded">ptr->f();</span>
</pre>
            </div>
            
            <div id="explanation-box" class="bg-slate-800 border-l-4 border-blue-500 p-4 text-gray-300 text-sm shadow-md transition-all">
                ç‚¹å‡»å³ä¸Šè§’çš„â€œä¸‹ä¸€æ­¥â€å¼€å§‹è§‚å¯Ÿ Thunk å¦‚ä½•ä»‹å…¥ã€‚
            </div>
        </div>

        <!-- ä¸­é—´ï¼šå†…å­˜å¸ƒå±€ -->
        <div class="col-span-4 flex flex-col items-center relative pt-10">
            
            <!-- å¤–éƒ¨æŒ‡é’ˆå¯è§†åŒ– -->
            <div id="active-pointer" class="absolute -left-10 top-32 flex items-center gap-2 transition-all opacity-0">
                <div id="pointer-label" class="bg-red-600 text-white text-xs px-2 py-1 rounded font-mono shadow-md transition-colors duration-500">Base2* ptr</div>
                <div id="pointer-arrow" class="text-red-600 text-2xl transition-colors duration-500">âœ</div>
            </div>

            <!-- å¯¹è±¡å†…å­˜å— -->
            <div id="memory-block" class="w-64 bg-slate-200 border-2 border-slate-600 rounded-lg overflow-hidden shadow-2xl relative text-slate-800">
                
                <!-- å†…å­˜åœ°å€æ ‡å°º -->
                <div id="addr-1000" class="absolute -left-14 top-0 text-xs text-gray-500 font-mono transition-colors duration-500">0x1000</div>
                <div id="addr-1010" class="absolute -left-14 top-[108px] text-xs text-gray-500 font-mono transition-colors duration-500">0x1010</div>

                <!-- Base 1 Subobject -->
                <div id="block-base1" class="bg-blue-100 border-b-2 border-dashed border-blue-300 p-2 relative transition-colors duration-500">
                    <span class="absolute right-2 top-1 text-[10px] text-blue-800 font-bold uppercase">Base1 (Offset 0)</span>
                    
                    <div class="h-10 border-2 border-blue-400 bg-white mb-1 flex items-center justify-between px-3 rounded text-slate-400 opacity-50">
                        <span class="font-mono text-sm font-bold">vptr_Base1</span>
                    </div>
                    <div class="h-8 border border-gray-300 bg-gray-50 flex items-center justify-center text-xs text-gray-500 rounded">
                        int b1
                    </div>
                </div>

                <!-- Base 2 Subobject -->
                <div class="bg-green-100 border-b-2 border-dashed border-green-300 p-2 relative">
                    <span class="absolute right-2 top-1 text-[10px] text-green-800 font-bold uppercase">Base2 (Offset 16)</span>
                    
                    <div id="mem-vptr2" class="h-10 border-2 border-green-500 bg-white mb-1 flex items-center justify-between px-3 rounded cursor-pointer transition z-20 relative">
                        <span class="font-mono text-sm font-bold text-green-900">vptr_Base2</span>
                        <div class="w-2 h-2 rounded-full bg-green-500 connector-dot" id="dot-vptr2"></div>
                    </div>
                    <div class="h-8 border border-gray-300 bg-gray-50 flex items-center justify-center text-xs text-gray-500 rounded">
                        int b2
                    </div>
                </div>

                <!-- Derived Members -->
                <div class="bg-purple-100 p-2 relative">
                    <span class="absolute right-2 top-1 text-[10px] text-purple-800 font-bold uppercase">Derived</span>
                    <div class="h-8 border border-gray-300 bg-gray-50 flex items-center justify-center text-xs text-gray-500 rounded">
                        int d
                    </div>
                </div>
            </div>
        </div>

        <!-- å³ä¾§ï¼šè™šå‡½æ•°è¡¨ & Thunk -->
        <div class="col-span-5 relative pt-12">
            
            <!-- VTable 2 -->
            <div class="relative mb-12">
                <h3 class="font-bold text-green-400 mb-2 text-sm ml-4">vtable for Base2-in-Derived</h3>
                <div id="vtable-2" class="bg-slate-800 border-2 border-green-700 rounded-lg shadow-md w-full ml-4 relative overflow-hidden">
                    <div class="absolute -left-3 top-6 w-3 h-0.5 bg-green-500" id="target-vptr2"></div>
                    
                    <!-- Thunk Entry -->
                    <div id="entry-thunk" class="flex border-b border-slate-600 p-3 bg-slate-700 transition relative">
                        <span class="font-mono text-xs text-gray-500 w-8 pt-1">+0</span>
                        <div class="flex flex-col w-full">
                            <span class="font-mono text-sm text-yellow-400 font-bold flex items-center justify-between">
                                &amp;__thunk_for_Derived_f
                                <span class="text-[10px] bg-yellow-900 text-yellow-200 px-1 rounded border border-yellow-700">Thunk</span>
                            </span>
                            <span class="text-[10px] text-gray-400">æŒ‡å‘ä¸€ä¸ªç¼–è¯‘å™¨ç”Ÿæˆçš„è¾…åŠ©å‡½æ•°</span>
                        </div>
                    </div>

                    <div class="flex p-3 opacity-50">
                        <span class="font-mono text-xs text-gray-500 w-8">+8</span>
                        <span class="font-mono text-sm text-gray-400">Base2::type_info</span>
                    </div>
                </div>
            </div>

            <!-- Thunk Code Window (The star of the show) -->
            <div id="thunk-window" class="absolute top-36 -left-12 w-[110%] bg-gray-900 rounded-lg shadow-2xl border border-yellow-600 z-50 overflow-hidden font-mono text-sm">
                <div class="bg-yellow-800 px-3 py-1 text-xs text-white font-bold flex justify-between items-center">
                    <span>ASSEMBLY / PSEUDO CODE</span>
                    <span>__thunk_for_Derived_f</span>
                </div>
                <div class="p-4 space-y-2">
                    <div id="thunk-line-1" class="px-2 py-1 rounded transition-colors flex items-center gap-4">
                        <span class="text-gray-500">0x4080:</span> 
                        <span class="text-purple-400 font-bold">sub</span> 
                        <span class="text-gray-300">rcx, 16</span>
                        <span class="text-gray-500 text-xs ml-auto">// this -= sizeof(Base1)</span>
                    </div>
                    <div id="thunk-line-2" class="px-2 py-1 rounded transition-colors flex items-center gap-4">
                        <span class="text-gray-500">0x4084:</span> 
                        <span class="text-blue-400 font-bold">jmp</span> 
                        <span class="text-gray-300">Derived::f</span>
                        <span class="text-gray-500 text-xs ml-auto">// è·³è½¬åˆ°çœŸå®å®ç°</span>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        // === é€»è¾‘æ§åˆ¶ ===
        let currentStep = 0;
        
        const steps = [
            {
                desc: "1. åˆå§‹çŠ¶æ€ï¼šæŒ‡é’ˆæŒ‡å‘å­å¯¹è±¡ Base2",
                action: () => {
                    const ptr = document.getElementById('active-pointer');
                    ptr.style.opacity = '1';
                    ptr.style.top = '150px'; // å®šä½åˆ° 0x1010
                    
                    highlightCode('code-cast');
                    updateExplain("<b>ä¸Šä¸‹æ–‡ï¼š</b><br/><code>ptr</code> æŒ‡å‘ Derived å¯¹è±¡ä¸­çš„ <b>Base2 å­å¯¹è±¡</b> (åœ°å€ 0x1010)ã€‚<br/>ä» Base2 çš„è§†è§’çœ‹ï¼Œå®ƒè®¤ä¸ºè‡ªå·±åªæ˜¯ä¸€ä¸ªæ™®é€šçš„ Base2 å¯¹è±¡ã€‚");
                }
            },
            {
                desc: "2. è™šå‡½æ•°è°ƒç”¨ï¼šæŸ¥è¡¨",
                action: () => {
                    highlightCode('code-call');
                    // æŒ‡å‘ vptr
                    document.getElementById('mem-vptr2').classList.add('highlight-flash');
                    
                    setTimeout(() => {
                        document.getElementById('mem-vptr2').classList.remove('highlight-flash');
                        drawArrow('dot-vptr2', 'target-vptr2', '#22c55e');
                        document.getElementById('vtable-2').classList.add('ring-2', 'ring-green-500');
                    }, 800);

                    updateExplain("<b>åŠ¨æ€ç»‘å®šï¼š</b><br/>ç¨‹åºé€šè¿‡ <code>vptr</code> æ‰¾åˆ°è™šè¡¨ã€‚<br/>æ³¨æ„ï¼šå› ä¸ºå½“å‰ <code>this</code> æŒ‡å‘ Base2 å­å¯¹è±¡ï¼Œæ‰€ä»¥ä½¿ç”¨çš„æ˜¯ <b>Base2-in-Derived</b> çš„ç‰¹åŒ–è™šè¡¨ã€‚");
                }
            },
            {
                desc: "3. å‘½ä¸­ Thunk æ¡ç›®",
                action: () => {
                    document.getElementById('entry-thunk').style.backgroundColor = '#3f6212'; // dark green
                    document.getElementById('entry-thunk').classList.add('ring-2', 'ring-yellow-500', 'z-10');
                    updateExplain("<b>å…³é”®ç‚¹ï¼š</b><br/>è™šè¡¨æ§½ä½ä¸­å¹¶æ²¡æœ‰ç›´æ¥å­˜æ”¾ <code>Derived::f</code> çš„åœ°å€ï¼Œè€Œæ˜¯å­˜æ”¾äº† <b>Thunk (ä¸­è½¬å‡½æ•°)</b> çš„åœ°å€ã€‚<br/>CPU æ­¤æ—¶è·³è½¬åˆ°è¿™æ®µâ€œèƒ¶æ°´ä»£ç â€æ‰§è¡Œã€‚");
                }
            },
            {
                desc: "4. æ‰§è¡Œ Thunkï¼šè°ƒæ•´æŒ‡é’ˆ (this adjustment)",
                action: () => {
                    // æ¿€æ´» Thunk çª—å£
                    document.getElementById('thunk-window').classList.add('active');
                    
                    setTimeout(() => {
                        // é«˜äº®ç¬¬ä¸€è¡Œä»£ç 
                        document.getElementById('thunk-line-1').classList.add('highlight-line');
                        
                        // ç§»åŠ¨æŒ‡é’ˆ
                        const ptr = document.getElementById('active-pointer');
                        ptr.style.top = '40px'; // ç§»åŠ¨åˆ° 0x1000
                        
                        // æ·»åŠ åŠ¨æ€æ ‡ç­¾
                        const badge = document.createElement('div');
                        badge.innerText = "-16 bytes";
                        badge.className = "absolute left-28 top-2 bg-yellow-600 text-white text-xs font-bold px-2 py-1 rounded animate-pulse z-50 whitespace-nowrap shadow-sm";
                        ptr.appendChild(badge);

                    }, 600);
                    
                    updateExplain("<b>Step 1: æŒ‡é’ˆè°ƒæ•´</b><br/>Thunk çš„ç¬¬ä¸€æ¡æŒ‡ä»¤ï¼š<code>sub rcx, 16</code>ã€‚<br/>å®ƒå°† <code>this</code> æŒ‡é’ˆä» <b>0x1010</b> å‡å» 16 å­—èŠ‚ï¼Œä½¿å…¶æŒ‡å‘ <b>0x1000</b> (å³ Derived å¯¹è±¡çš„çœŸæ­£èµ·å§‹åœ°å€)ã€‚");
                }
            },
            {
                desc: "5. æ‰§è¡Œ Thunkï¼šè·³è½¬çœŸå®å®ç°",
                action: () => {
                    // å»æ‰ç¬¬ä¸€è¡Œé«˜äº®ï¼Œé«˜äº®ç¬¬äºŒè¡Œ
                    document.getElementById('thunk-line-1').classList.remove('highlight-line');
                    document.getElementById('thunk-line-2').classList.add('highlight-line');
                    
                    // æ”¹å˜æŒ‡é’ˆçŠ¶æ€
                    setTimeout(() => {
                        const ptrLabel = document.getElementById('pointer-label');
                        ptrLabel.innerText = "this (Derived*)";
                        ptrLabel.className = "bg-purple-600 text-white text-xs px-2 py-1 rounded font-mono shadow-md transition-colors duration-500";
                        document.getElementById('pointer-arrow').className = "text-purple-600 text-2xl transition-colors duration-500";
                        
                        // æ ‡è®°åˆ°è¾¾
                        const memBlock = document.getElementById('memory-block');
                        const arrivedLabel = document.createElement('div');
                        arrivedLabel.className = "absolute -right-40 top-4 text-purple-400 font-bold text-sm bg-slate-800 px-2 py-1 border border-purple-500 rounded shadow target-marker";
                        arrivedLabel.innerText = "ğŸ‘ˆ Correct 'this'";
                        memBlock.appendChild(arrivedLabel);
                        
                        // é«˜äº®æºç å®ç°
                        highlightCode('code-f3-impl');
                        document.getElementById('code-f3-impl').style.backgroundColor = '#6b21a8'; // purple
                        
                    }, 500);

                    updateExplain("<b>Step 2: è·³è½¬</b><br/><code>this</code> æŒ‡é’ˆä¿®æ­£å®Œæ¯•åï¼ŒThunk æ‰§è¡Œ <code>jmp Derived::f</code>ã€‚<br/>ç°åœ¨å‡½æ•°ä½“å†…éƒ¨å¯ä»¥å®‰å…¨åœ°é€šè¿‡åç§»é‡è®¿é—® <code>Derived</code> çš„æˆå‘˜å˜é‡ <code>d</code> æˆ–åŸºç±»æˆå‘˜ <code>b1</code> äº†ã€‚");
                }
            }
        ];

        function nextStep() {
            if (currentStep < steps.length) {
                const step = steps[currentStep];
                document.getElementById('step-desc').innerText = `(${currentStep + 1}/${steps.length})`;
                step.action();
                currentStep++;
            } else {
                alert("æ¼”ç¤ºç»“æŸã€‚è¿™å°±æ˜¯å¤šé‡ç»§æ‰¿ä¸‹â€œæŒ‡é’ˆè°ƒæ•´â€çš„å¥¥ç§˜ï¼");
            }
        }

        function resetDemo() {
            currentStep = 0;
            document.getElementById('step-desc').innerText = "(å‡†å¤‡å¼€å§‹)";
            const ptr = document.getElementById('active-pointer');
            ptr.style.opacity = '0';
            ptr.style.top = '32px';
            
            // é‡ç½®æŒ‡é’ˆ
            ptr.innerHTML = `
                <div id="pointer-label" class="bg-red-600 text-white text-xs px-2 py-1 rounded font-mono shadow-md transition-colors duration-500">Base2* ptr</div>
                <div id="pointer-arrow" class="text-red-600 text-2xl transition-colors duration-500">âœ</div>
            `;
            
            // æ¸…é™¤å„ç§æ ·å¼
            document.querySelectorAll('.highlight-flash').forEach(el => el.classList.remove('highlight-flash'));
            document.querySelectorAll('.highlight-line').forEach(el => el.classList.remove('highlight-line'));
            document.getElementById('vtable-2').classList.remove('ring-2', 'ring-green-500');
            
            const entryThunk = document.getElementById('entry-thunk');
            entryThunk.style.backgroundColor = '';
            entryThunk.classList.remove('ring-2', 'ring-yellow-500', 'z-10');
            
            document.getElementById('thunk-window').classList.remove('active');
            
            document.getElementById('code-f3-impl').style.backgroundColor = 'transparent';
            
            const marker = document.querySelector('.target-marker');
            if(marker) marker.remove();

            // æ¸…é™¤ SVG
            document.getElementById('svg-layer').innerHTML = '';
            
            // æ¸…é™¤ä»£ç é«˜äº®
            ['code-cast', 'code-call', 'code-f3-impl'].forEach(id => {
                const el = document.getElementById(id);
                if(el) el.style.backgroundColor = 'transparent';
            });

            updateExplain("ç‚¹å‡»â€œä¸‹ä¸€æ­¥â€å¼€å§‹è§‚å¯Ÿ Thunk å¦‚ä½•ä»‹å…¥ã€‚");
        }

        function updateExplain(html) {
            const box = document.getElementById('explanation-box');
            box.style.opacity = 0;
            setTimeout(() => {
                box.innerHTML = html;
                box.style.opacity = 1;
            }, 200);
        }

        function highlightCode(id) {
            document.querySelectorAll('[id^="code-"]').forEach(el => el.style.backgroundColor = 'transparent');
            const el = document.getElementById(id);
            if(el) {
                el.style.backgroundColor = '#334155';
                el.style.color = 'white';
            }
        }

        function drawArrow(startId, endId, color) {
            const svg = document.getElementById('svg-layer');
            const startElem = document.getElementById(startId);
            const endElem = document.getElementById(endId);

            if (!startElem || !endElem) return;

            const startRect = startElem.getBoundingClientRect();
            const endRect = endElem.getBoundingClientRect();
            const containerRect = svg.getBoundingClientRect();

            const x1 = startRect.left + startRect.width / 2 - containerRect.left;
            const y1 = startRect.top + startRect.height / 2 - containerRect.top;
            const x2 = endRect.left - containerRect.left;
            const y2 = endRect.top + endRect.height / 2 - containerRect.top;

            const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
            
            const controlX1 = x1 + (x2 - x1) / 2;
            const controlY1 = y1;
            const controlX2 = x1 + (x2 - x1) / 2;
            const controlY2 = y2;

            const d = `M ${x1} ${y1} C ${controlX1} ${controlY1}, ${controlX2} ${controlY2}, ${x2} ${y2}`;
            
            path.setAttribute("d", d);
            path.setAttribute("stroke", color);
            path.setAttribute("stroke-width", "2");
            path.setAttribute("fill", "none");
            path.setAttribute("stroke-dasharray", "1000");
            path.setAttribute("stroke-dashoffset", "1000");
            
            svg.appendChild(path);

            // è¿çº¿åŠ¨ç”»
            path.style.transition = "stroke-dashoffset 0.8s ease-out";
            setTimeout(() => {
                path.setAttribute("stroke-dashoffset", "0");
            }, 10);
        }

        window.onload = resetDemo;
        window.onresize = () => {
            document.getElementById('svg-layer').innerHTML = '';
            if(currentStep > 1) drawArrow('dot-vptr2', 'target-vptr2', '#22c55e');
        };
    </script>
</body>
</html>