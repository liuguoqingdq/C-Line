<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>I/O 多路复用对比演示</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes pulse-blue {
            0%, 100% { background-color: rgba(59, 130, 246, 0.08); }
            50% { background-color: rgba(59, 130, 246, 0.25); }
        }
        @keyframes pulse-emerald {
            0%, 100% { background-color: rgba(16, 185, 129, 0.1); }
            50% { background-color: rgba(16, 185, 129, 0.3); }
        }
        .animate-pulse-blue { animation: pulse-blue 2s infinite; }
        .animate-pulse-emerald { animation: pulse-emerald 2s infinite; }
        .syscall-arrow { transition: all 0.7s cubic-bezier(0.4, 0, 0.2, 1); opacity: 0; }
        .syscall-arrow.active { opacity: 1; transform: scale(1.2); }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #111827; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 2px; }
    </style>
</head>
<body class="bg-slate-950 text-slate-100 font-sans">
    <div class="max-w-7xl mx-auto p-4 md:p-8 space-y-8">
        <header class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4">
            <div>
                <h1 class="text-3xl font-black text-white flex items-center gap-2">
                    <svg class="w-8 h-8 text-sky-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4"></path></svg>
                    I/O 多路复用对比演示
                </h1>
                <p class="text-slate-400 text-sm mt-2">
                    一次看懂 <span class="text-sky-300 font-semibold">SELECT</span> / <span class="text-amber-300 font-semibold">POLL</span> / <span class="text-emerald-300 font-semibold">EPOLL</span> 的拷贝、扫描与就绪队列差异。
                </p>
            </div>
            <div class="flex bg-white/10 p-1 rounded-2xl border border-white/10" id="tabContainer">
                <button onclick="switchTab('select')" id="btn-select" class="tab-btn px-6 py-2 rounded-xl font-bold transition-all text-sm bg-sky-500 text-white shadow-lg">SELECT</button>
                <button onclick="switchTab('poll')" id="btn-poll" class="tab-btn px-6 py-2 rounded-xl font-bold transition-all text-sm text-slate-400 hover:bg-white/10">POLL</button>
                <button onclick="switchTab('epoll')" id="btn-epoll" class="tab-btn px-6 py-2 rounded-xl font-bold transition-all text-sm text-slate-400 hover:bg-white/10">EPOLL</button>
            </div>
        </header>

        <div class="grid lg:grid-cols-12 gap-6">
            <div class="lg:col-span-4 space-y-6">
                <div id="userspace-card" class="bg-white/5 rounded-3xl p-6 shadow-lg border border-white/10">
                    <div class="flex justify-between items-center mb-6">
                        <div class="flex items-center gap-2 text-sky-300 font-bold uppercase tracking-wider text-xs">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                            用户空间 (Interest)
                        </div>
                        <span id="userspace-badge" class="text-[10px] bg-slate-800 px-2 py-1 rounded font-bold text-slate-400">监听意图</span>
                    </div>

                    <div class="grid grid-cols-4 gap-3 mb-8" id="fd-grid">
                        <!-- FD Boxes generated by JS -->
                    </div>

                    <div class="space-y-3">
                        <button id="run-btn" onclick="runSimulation()" class="w-full py-3 rounded-xl bg-slate-100 text-slate-900 font-bold hover:bg-white shadow-lg transition-all flex items-center justify-center gap-2 active:scale-95">
                            <svg id="run-icon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                            执行系统调用
                        </button>
                        <button onclick="randomizeReady()" class="w-full py-2 rounded-xl border border-white/10 text-sm text-slate-300 hover:bg-white/10 transition-all">
                            重新随机硬件就绪
                        </button>
                    </div>
                </div>

                <div class="bg-emerald-500/10 rounded-3xl p-6 shadow-xl border border-emerald-500/20">
                    <div class="flex items-center gap-2 mb-4 text-emerald-300 font-bold text-xs uppercase tracking-widest">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M15 12a3 3 0 11-6 0 3 0 016 0z"></path><path d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                        返回结果 (Result)
                    </div>
                    <div id="results-display" class="min-h-[60px] flex flex-wrap gap-2 items-center justify-center text-emerald-200/60 italic text-xs">
                        等待结果返回...
                    </div>
                </div>

                <div class="bg-white/5 rounded-3xl p-6 border border-white/10 text-xs space-y-3">
                    <div class="font-bold uppercase text-slate-400 tracking-widest">图例</div>
                    <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-sky-500"></span> 监听兴趣</div>
                    <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-emerald-500"></span> 硬件就绪</div>
                    <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-amber-400"></span> 内核扫描中</div>
                </div>
            </div>

            <div class="lg:col-span-1 flex flex-col items-center justify-center gap-8 py-10">
                <div id="arrow-in" class="syscall-arrow text-slate-500">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24"><path d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
                </div>
                <div id="arrow-out" class="syscall-arrow text-slate-500">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24"><path d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                </div>
            </div>

            <div class="lg:col-span-7 space-y-6">
                <div id="kernel-card" class="bg-slate-900 rounded-3xl p-6 shadow-2xl border border-slate-800 text-white relative transition-all">
                    <div class="flex justify-between items-center mb-6">
                        <div class="flex items-center gap-2 text-slate-400 font-bold uppercase tracking-wider text-xs">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"></path></svg>
                            内核空间 (Kernel)
                        </div>
                        <div class="flex items-center gap-3">
                            <div class="flex items-center gap-1">
                                <div class="w-2 h-2 rounded-full bg-emerald-500"></div>
                                <span class="text-[10px] text-slate-500 font-bold">硬件就绪</span>
                            </div>
                            <div class="flex items-center gap-1">
                                <div class="w-2 h-2 rounded-full bg-sky-500"></div>
                                <span class="text-[10px] text-slate-500 font-bold">监听中</span>
                            </div>
                        </div>
                    </div>

                    <div class="bg-black/40 rounded-2xl p-6 border border-slate-800 mb-6 min-h-[180px]">
                        <h4 id="kernel-memory-title" class="text-[10px] font-bold text-slate-500 mb-4 uppercase tracking-tighter flex items-center gap-1">
                            内核内存：兴趣位图
                        </h4>
                        <div id="kernel-viz" class="grid grid-cols-4 sm:grid-cols-8 gap-3"></div>
                    </div>

                    <div class="bg-slate-800/80 rounded-xl p-4 font-mono text-xs border-l-4 border-sky-500">
                        <div class="flex gap-2">
                            <svg class="w-4 h-4 text-sky-400 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                            <span id="log-text" class="text-slate-300 leading-relaxed">等待启动...</span>
                        </div>
                    </div>
                </div>

                <div class="grid md:grid-cols-3 gap-4">
                    <div class="bg-white/5 rounded-3xl p-5 border border-white/10">
                        <h3 class="font-bold text-xs uppercase tracking-widest text-slate-400 mb-3">SELECT</h3>
                        <p class="text-xs text-slate-300 leading-relaxed">
                            每次调用都需要把用户态位图拷贝进内核，扫描 O(N)，返回时会覆盖原始位图。
                        </p>
                    </div>
                    <div class="bg-white/5 rounded-3xl p-5 border border-white/10">
                        <h3 class="font-bold text-xs uppercase tracking-widest text-slate-400 mb-3">POLL</h3>
                        <p class="text-xs text-slate-300 leading-relaxed">
                            每次调用拷贝监听列表，仍需线性扫描，但返回结果不会破坏原始监听集合。
                        </p>
                    </div>
                    <div class="bg-white/5 rounded-3xl p-5 border border-white/10">
                        <h3 class="font-bold text-xs uppercase tracking-widest text-slate-400 mb-3">EPOLL</h3>
                        <p class="text-xs text-slate-300 leading-relaxed">
                            只在注册时拷贝，内核维护红黑树与就绪队列，返回就绪列表无需全量扫描。
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const FD_COUNT = 8;
        let activeTab = 'select';
        let phase = 'IDLE';
        let userInterests = new Set();
        let kernelMemory = new Set();
        let hardwareReady = Array.from({ length: FD_COUNT }, () => Math.random() > 0.6);
        let scanIdx = -1;

        function init() {
            renderUserGrid();
            renderKernelViz();
            updateLog(`切换到 ${activeTab.toUpperCase()}。请先在左侧勾选你感兴趣的 FD，然后执行。`);
        }

        function randomizeReady() {
            hardwareReady = Array.from({ length: FD_COUNT }, () => Math.random() > 0.6);
            renderKernelViz();
            updateLog('已刷新硬件就绪状态。');
        }

        function renderUserGrid() {
            const grid = document.getElementById('fd-grid');
            grid.innerHTML = '';
            for (let i = 0; i < FD_COUNT; i++) {
                const box = document.createElement('div');
                const isInterested = userInterests.has(i);
                box.className = `relative h-14 rounded-xl border-2 flex flex-col items-center justify-center transition-all cursor-pointer ${isInterested ? 'bg-sky-500/20 border-sky-400 text-sky-200' : 'bg-white/5 border-white/10 text-slate-400'} ${phase !== 'IDLE' ? 'opacity-50 pointer-events-none' : 'hover:border-sky-400/70'}`;
                box.onclick = () => toggleInterest(i);
                box.innerHTML = `
                    <span class="text-[10px] font-mono font-bold">FD_${i}</span>
                    <div class="mt-1 w-2 h-2 rounded-full ${isInterested ? 'bg-sky-400 animate-pulse-blue' : 'bg-slate-600'}"></div>
                `;
                grid.appendChild(box);
            }
        }

        function renderKernelViz() {
            const viz = document.getElementById('kernel-viz');
            viz.innerHTML = '';

            if (activeTab === 'epoll') {
                const container = document.createElement('div');
                container.className = 'col-span-full flex flex-col gap-4 w-full';
                const tree = document.createElement('div');
                tree.className = 'border-b border-slate-800 pb-4 text-center';
                tree.innerHTML = `
                    <div class="text-sky-400 text-[10px] font-bold mb-2">兴趣红黑树 (Interest Tree)</div>
                    <div class="flex justify-center gap-2">
                        ${Array.from({length: 5}).map((_, i) => `<div class="w-3 h-3 rounded-full ${kernelMemory.has(i) ? 'bg-sky-500' : 'bg-slate-700'}"></div>`).join('')}
                    </div>
                `;
                const list = document.createElement('div');
                list.className = 'text-left';
                list.innerHTML = `
                    <div class="text-emerald-500 text-[10px] font-bold mb-2">就绪链表 (rdllist)</div>
                    <div id="rdllist-items" class="flex gap-2 min-h-[24px]"></div>
                `;
                container.appendChild(tree);
                container.appendChild(list);
                viz.appendChild(container);
                return;
            }

            for (let i = 0; i < (activeTab === 'select' ? 32 : FD_COUNT); i++) {
                const cell = document.createElement('div');
                const isInterested = kernelMemory.has(i);
                const isHardwareReady = i < FD_COUNT && hardwareReady[i];
                const isScanning = scanIdx === i;
                cell.className = `relative h-12 rounded-lg border flex flex-col items-center justify-center transition-all ${isScanning ? 'ring-2 ring-amber-400 bg-amber-400/20' : isInterested ? 'bg-sky-500/20 border-sky-500/50' : 'bg-slate-800/50 border-slate-700'}`;
                cell.innerHTML = `
                    <span class="text-[10px] font-mono font-bold text-slate-500">#${i}</span>
                    <div class="flex gap-1">
                        <div class="w-1.5 h-1.5 rounded-full ${isInterested ? 'bg-sky-500' : 'bg-transparent'}"></div>
                        <div class="w-1.5 h-1.5 rounded-full ${isHardwareReady ? 'bg-emerald-500 animate-pulse-emerald' : 'bg-transparent'}"></div>
                    </div>
                `;
                viz.appendChild(cell);
            }
        }

        function toggleInterest(id) {
            if (userInterests.has(id)) userInterests.delete(id);
            else userInterests.add(id);
            renderUserGrid();
        }

        function switchTab(tab) {
            activeTab = tab;
            phase = 'IDLE';
            userInterests.clear();
            kernelMemory.clear();
            scanIdx = -1;
            hardwareReady = Array.from({ length: FD_COUNT }, () => Math.random() > 0.6);

            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.className = "tab-btn px-6 py-2 rounded-xl font-bold transition-all text-sm text-slate-400 hover:bg-white/10";
            });
            const activeBtn = document.getElementById(`btn-${tab}`);
            activeBtn.className = "tab-btn px-6 py-2 rounded-xl font-bold transition-all text-sm bg-sky-500 text-white shadow-lg";

            document.getElementById('kernel-memory-title').innerText = tab === 'epoll' ? '内核内存：红黑树 + 就绪链表' : '内核内存：兴趣位图缓冲区';
            document.getElementById('results-display').innerHTML = '等待结果返回...';
            init();
        }

        function updateLog(text) {
            document.getElementById('log-text').innerText = text;
        }

        async function runSimulation() {
            if (phase !== 'IDLE') return;
            if (userInterests.size === 0 && activeTab !== 'epoll') {
                updateLog("请先勾选左侧想要监听的 FD！");
                return;
            }

            const resultsContainer = document.getElementById('results-display');
            resultsContainer.innerHTML = '内核处理中...';
            resultsContainer.className = "min-h-[60px] flex flex-wrap gap-2 items-center justify-center text-emerald-200/60 italic text-xs animate-pulse";

            if (activeTab === 'select' || activeTab === 'poll') {
                phase = 'SYSCALL_IN';
                document.getElementById('arrow-in').classList.add('active', 'text-sky-400');
                updateLog(`[Copy-In] 用户态监听集合拷贝进入内核。`);
                await new Promise(r => setTimeout(r, 1000));

                kernelMemory = new Set(userInterests);
                renderKernelViz();
                await new Promise(r => setTimeout(r, 500));
                document.getElementById('arrow-in').classList.remove('active', 'text-sky-400');

                phase = 'PROCESSING';
                updateLog(`内核扫描 O(N)：逐个对比硬件就绪状态...`);
                let found = [];
                for (let i = 0; i < FD_COUNT; i++) {
                    scanIdx = i;
                    renderKernelViz();
                    await new Promise(r => setTimeout(r, 250));
                    if (userInterests.has(i) && hardwareReady[i]) {
                        found.push(i);
                    }
                }
                scanIdx = -1;

                phase = 'SYSCALL_OUT';
                document.getElementById('arrow-out').classList.add('active', 'text-emerald-400');
                updateLog(`[Copy-Out] 返回就绪集合。`);
                showResults(found);

                if (activeTab === 'select') {
                    kernelMemory = new Set(found);
                    renderKernelViz();
                    await new Promise(r => setTimeout(r, 800));
                    updateLog("⚠️ SELECT 覆盖了原始位图，需要重新设置监听集合。");
                    userInterests = new Set(found);
                    renderUserGrid();
                }

                await new Promise(r => setTimeout(r, 1000));
                document.getElementById('arrow-out').classList.remove('active', 'text-emerald-400');
            } else {
                phase = 'SYSCALL_IN';
                updateLog("EPOLL_CTL：增量注册 FD 到红黑树。");
                kernelMemory = new Set([...kernelMemory, ...userInterests]);
                renderKernelViz();
                await new Promise(r => setTimeout(r, 800));

                phase = 'PROCESSING';
                updateLog("EPOLL_WAIT：进程挂起，等待中断填充就绪链表...");
                await new Promise(r => setTimeout(r, 1500));

                let found = hardwareReady.map((isR, i) => isR && kernelMemory.has(i) ? i : null).filter(v => v !== null);
                const list = document.getElementById('rdllist-items');
                list.innerHTML = '';
                found.forEach(id => {
                    const item = document.createElement('div');
                    item.className = 'px-2 py-0.5 bg-emerald-600 text-white rounded text-[9px] font-bold';
                    item.innerText = `FD_${id}`;
                    list.appendChild(item);
                });

                phase = 'SYSCALL_OUT';
                updateLog(`[Notify] 就绪队列直接返回 ${found.length} 个结果。`);
                showResults(found);
                await new Promise(r => setTimeout(r, 1000));
            }

            phase = 'IDLE';
            if (activeTab !== 'epoll') kernelMemory.clear();
            renderKernelViz();
            renderUserGrid();
        }

        function showResults(found) {
            const resultsContainer = document.getElementById('results-display');
            resultsContainer.classList.remove('animate-pulse', 'text-emerald-200/60', 'italic');
            resultsContainer.innerHTML = '';

            if (found.length === 0) {
                resultsContainer.innerHTML = '<span class="text-slate-400">无就绪事件</span>';
                return;
            }

            found.forEach(id => {
                const badge = document.createElement('div');
                badge.className = 'bg-emerald-500/20 px-3 py-1 rounded-lg flex items-center gap-2 border border-emerald-500/30 text-emerald-200 font-mono font-bold text-sm';
                badge.innerHTML = `
                    <svg class="w-4 h-4 text-emerald-300" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>
                    FD_${id} Ready
                `;
                resultsContainer.appendChild(badge);
            });
        }

        init();
    </script>
</body>
</html>
