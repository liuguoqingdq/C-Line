<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>中位数算法 - 代码级调试演示</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Consolas', 'Monaco', monospace; background-color: #1e1e1e; color: #d4d4d4; }
        
        /* Array Visualization Styles */
        .array-cell {
            width: 45px; height: 45px;
            display: flex; align-items: center; justify-content: center;
            border: 2px solid #444; margin: 2px;
            font-weight: bold; position: relative; transition: all 0.3s;
            background-color: #252526;
        }
        
        /* Divider (Partition Line) */
        .divider {
            width: 4px; height: 60px;
            background-color: #f59e0b;
            position: absolute; z-index: 20; top: -8px;
            transition: left 0.4s ease-in-out;
            box-shadow: 0 0 8px rgba(245, 158, 11, 0.6);
        }
        .divider::after {
            content: ''; position: absolute; bottom: -15px; left: -8px;
            border-left: 10px solid transparent; border-right: 10px solid transparent; border-top: 10px solid #f59e0b;
        }

        /* Highlights */
        .hl-val { border-color: #f59e0b; color: #fff; background-color: #555; transform: scale(1.1); z-index: 10; }
        .hl-left { background-color: rgba(59, 130, 246, 0.15); border-color: #3b82f6; } /* Blue tint */
        .hl-right { background-color: rgba(239, 68, 68, 0.15); border-color: #ef4444; } /* Red tint */
        
        /* Code Trace Styles */
        .code-line { padding: 2px 8px; border-left: 3px solid transparent; opacity: 0.6; font-size: 13px; white-space: pre; }
        .code-active { background-color: #37373d; border-left-color: #f59e0b; opacity: 1; color: #fff; font-weight: bold; }

        /* Animation */
        @keyframes pulse-success {
            0% { box-shadow: 0 0 0 0 rgba(74, 222, 128, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(74, 222, 128, 0); }
            100% { box-shadow: 0 0 0 0 rgba(74, 222, 128, 0); }
        }
        .success-pulse { animation: pulse-success 1.5s infinite; border-color: #4ade80 !important; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <!-- Header -->
    <header class="bg-[#2d2d30] p-3 border-b border-[#333] shrink-0 flex justify-between items-center">
        <h1 class="text-lg font-bold text-white"><i class="fa-solid fa-bug text-amber-500 mr-2"></i>二分查找中位数 - 代码调试模式</h1>
        <div class="text-xs text-gray-500">Step-by-Step Debugger View</div>
    </header>

    <div class="flex-1 flex overflow-hidden">
        
        <!-- Left: Code & Controls -->
        <div class="w-1/3 bg-[#252526] flex flex-col border-r border-[#333]">
            
            <!-- Controls -->
            <div class="p-4 border-b border-[#333] shrink-0 bg-[#1e1e1e]">
                <div class="flex gap-2 mb-3">
                    <div class="flex-1">
                        <label class="text-xs text-gray-500 block mb-1">Nums 1 (短)</label>
                        <input id="in-n1" type="text" value="1, 3, 8, 9, 15" class="w-full bg-[#333] border border-[#555] text-white text-sm px-2 py-1 rounded font-mono">
                    </div>
                    <div class="flex-1">
                        <label class="text-xs text-gray-500 block mb-1">Nums 2 (长)</label>
                        <input id="in-n2" type="text" value="7, 11, 18, 19, 21, 25" class="w-full bg-[#333] border border-[#555] text-white text-sm px-2 py-1 rounded font-mono">
                    </div>
                </div>
                <div class="flex gap-2">
                    <button id="btn-reset" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 rounded text-sm font-bold flex-1 transition"><i class="fa-solid fa-rotate-right mr-1"></i> 重置/加载</button>
                    <button id="btn-step" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1.5 rounded text-sm font-bold flex-1 transition disabled:opacity-50 disabled:cursor-not-allowed" disabled><i class="fa-solid fa-arrow-right-to-bracket mr-1"></i> 单步执行 (F10)</button>
                </div>
            </div>

            <!-- Variable Watch -->
            <div class="p-3 border-b border-[#333] bg-[#1e1e1e] font-mono text-xs grid grid-cols-2 gap-y-1 gap-x-4">
                <div class="text-gray-400">low: <span id="var-low" class="text-white">-</span></div>
                <div class="text-gray-400">high: <span id="var-high" class="text-white">-</span></div>
                <div class="text-gray-400">i (partX): <span id="var-i" class="text-amber-400 font-bold">-</span></div>
                <div class="text-gray-400">j (partY): <span id="var-j" class="text-amber-400 font-bold">-</span></div>
                <div class="col-span-2 border-t border-[#333] my-1"></div>
                <div class="text-blue-400">L1: <span id="var-l1">-</span></div>
                <div class="text-red-400">R1: <span id="var-r1">-</span></div>
                <div class="text-blue-400">L2: <span id="var-l2">-</span></div>
                <div class="text-red-400">R2: <span id="var-r2">-</span></div>
            </div>

            <!-- Code Trace -->
            <div class="flex-1 overflow-y-auto bg-[#1e1e1e] p-2 select-none">
                <div id="code-0" class="code-line text-gray-500">// 初始化: low=0, high=len1, total=(len1+len2+1)/2</div>
                <div id="code-1" class="code-line">while (low <= high) {</div>
                <div id="code-2" class="code-line">  int i = (low + high) / 2;    // Partition X</div>
                <div id="code-3" class="code-line">  int j = totalLeft - i;       // Partition Y</div>
                <div id="code-4" class="code-line"></div>
                <div id="code-5" class="code-line">  // 获取边界值 (处理 ±Infinity)</div>
                <div id="code-6" class="code-line">  int L1 = nums1[i-1], R1 = nums1[i];</div>
                <div id="code-7" class="code-line">  int L2 = nums2[j-1], R2 = nums2[j];</div>
                <div id="code-8" class="code-line"></div>
                <div id="code-9" class="code-line">  // 交叉比较</div>
                <div id="code-10" class="code-line">  if (L1 > R2) {</div>
                <div id="code-11" class="code-line">    high = i - 1;  // L1太大了, 左移</div>
                <div id="code-12" class="code-line">  }</div>
                <div id="code-13" class="code-line">  else if (L2 > R1) {</div>
                <div id="code-14" class="code-line">    low = i + 1;   // L2太大了, 右移</div>
                <div id="code-15" class="code-line">  }</div>
                <div id="code-16" class="code-line">  else {</div>
                <div id="code-17" class="code-line">    // 找到中位数! 计算并返回</div>
                <div id="code-18" class="code-line">    return calcMedian(L1, R1, L2, R2);</div>
                <div id="code-19" class="code-line">  }</div>
                <div id="code-20" class="code-line">}</div>
            </div>
            
            <!-- Console Log -->
            <div id="log-panel" class="h-32 bg-[#1e1e1e] border-t border-[#333] p-2 overflow-y-auto font-mono text-xs text-gray-400">
                <div>> Ready.</div>
            </div>
        </div>

        <!-- Right: Visualization -->
        <div class="w-2/3 bg-[#1e1e1e] p-6 relative flex flex-col">
            
            <!-- Global Range Indicator -->
            <div class="h-6 mb-8 relative">
                <div class="text-xs text-gray-500 mb-1">二分查找范围 (Search Range on Nums1):</div>
                <div class="w-full h-1 bg-[#333] rounded"></div>
                <!-- Range Bar -->
                <div id="range-bar" class="absolute top-[18px] h-1.5 bg-green-500 rounded transition-all duration-300" style="left:0; width:0;"></div>
            </div>

            <!-- Arrays -->
            <div class="flex-1 flex flex-col justify-center space-y-12">
                
                <!-- Nums 1 -->
                <div class="relative">
                    <div class="text-xs text-gray-500 mb-1 ml-1 font-bold">Nums 1 (i)</div>
                    <div id="cont-n1" class="flex flex-wrap relative pl-4"></div>
                    <div id="div-n1" class="divider"></div>
                </div>

                <!-- Nums 2 -->
                <div class="relative">
                    <div class="text-xs text-gray-500 mb-1 ml-1 font-bold">Nums 2 (j)</div>
                    <div id="cont-n2" class="flex flex-wrap relative pl-4"></div>
                    <div id="div-n2" class="divider"></div>
                </div>
            </div>

            <!-- Comparison Popup (Overlay) -->
            <div id="cmp-popup" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-[#2d2d30] border border-gray-600 p-4 rounded shadow-2xl z-50 hidden opacity-0 transition-opacity duration-300">
                <div class="text-center">
                    <div class="text-xs text-gray-400 mb-2 uppercase tracking-wide">Cross Check</div>
                    <div class="flex items-center gap-4 text-xl font-bold mb-2">
                        <div id="cmp-left" class="text-blue-400">L1</div>
                        <div class="text-gray-500">vs</div>
                        <div id="cmp-right" class="text-red-400">R2</div>
                    </div>
                    <div id="cmp-res" class="text-sm font-bold">OK</div>
                </div>
            </div>

            <!-- Result Overlay -->
            <div id="res-overlay" class="absolute inset-0 bg-black/60 z-40 flex items-center justify-center hidden backdrop-blur-sm">
                <div class="bg-[#252526] p-8 rounded-xl border border-green-500 shadow-2xl text-center transform scale-110">
                    <div class="text-green-500 text-4xl mb-2"><i class="fa-solid fa-circle-check"></i></div>
                    <h2 class="text-2xl font-bold text-white mb-1">Found!</h2>
                    <div class="text-gray-400 text-sm mb-4">Median Calculation</div>
                    <div id="final-calc" class="text-xl font-mono bg-black/30 p-3 rounded text-green-300 mb-4">
                        (max(L1,L2) + min(R1,R2)) / 2
                    </div>
                    <div class="text-4xl font-bold text-white" id="final-val">0.0</div>
                </div>
            </div>

        </div>
    </div>

    <script>
        // --- State Machine for Debugging ---
        const State = {
            INIT: 0,
            LOOP_CHECK: 1,
            CALC_PARTITION: 2,
            GET_BOUNDARIES: 3,
            CHECK_1: 4,      // L1 <= R2
            CHECK_2: 5,      // L2 <= R1
            DECISION: 6,     // Update low/high or Found
            FOUND: 99
        };

        // --- Data ---
        let nums1 = [], nums2 = [];
        // REPAIR: Renamed m, n to len1, len2 to avoid global conflicts
        let len1 = 0, len2 = 0, totalLeft = 0;
        let low = 0, high = 0;
        let i = 0, j = 0;
        let L1, R1, L2, R2;
        let currentState = State.INIT;

        // --- DOM Cache ---
        const els = {
            n1: document.getElementById('in-n1'),
            n2: document.getElementById('in-n2'),
            btnReset: document.getElementById('btn-reset'),
            btnStep: document.getElementById('btn-step'),
            cN1: document.getElementById('cont-n1'),
            cN2: document.getElementById('cont-n2'),
            dN1: document.getElementById('div-n1'),
            dN2: document.getElementById('div-n2'),
            log: document.getElementById('log-panel'),
            rangeBar: document.getElementById('range-bar'),
            cmpPopup: document.getElementById('cmp-popup'),
            cmpLeft: document.getElementById('cmp-left'),
            cmpRight: document.getElementById('cmp-right'),
            cmpRes: document.getElementById('cmp-res'),
            resOverlay: document.getElementById('res-overlay'),
            
            // Vars
            vLow: document.getElementById('var-low'),
            vHigh: document.getElementById('var-high'),
            vI: document.getElementById('var-i'),
            vJ: document.getElementById('var-j'),
            vL1: document.getElementById('var-l1'),
            vR1: document.getElementById('var-r1'),
            vL2: document.getElementById('var-l2'),
            vR2: document.getElementById('var-r2')
        };

        // --- Init ---
        els.btnReset.addEventListener('click', init);
        els.btnStep.addEventListener('click', step);
        document.addEventListener('keydown', (e) => {
            if(e.key === 'F10' && !els.btnStep.disabled) step();
        });

        [els.n1, els.n2].forEach(inp => {
            inp.addEventListener('input', () => {
                els.btnStep.disabled = true;
                els.btnStep.classList.replace('bg-green-600', 'bg-gray-600');
            });
        });

        function parse(str) {
            // REPAIR: Renamed parameter n to val
            return str.split(',').map(s => parseInt(s.trim())).filter(val => !isNaN(val)).sort((a,b)=>a-b);
        }

        function init() {
            // Logic Init
            nums1 = parse(els.n1.value);
            nums2 = parse(els.n2.value);

            if (nums1.length > nums2.length) {
                log("Swap arrays to ensure Nums1 is shorter.");
                [nums1, nums2] = [nums2, nums1];
                els.n1.value = nums1.join(', ');
                els.n2.value = nums2.join(', ');
            }

            len1 = nums1.length;
            len2 = nums2.length;
            totalLeft = Math.floor((len1 + len2 + 1) / 2);
            low = 0;
            high = len1;
            currentState = State.LOOP_CHECK;

            // UI Reset
            els.cN1.innerHTML = nums1.map((v, idx) => `<div class="array-cell" id="c1-${idx}">${v}</div>`).join('');
            els.cN2.innerHTML = nums2.map((v, idx) => `<div class="array-cell" id="c2-${idx}">${v}</div>`).join('');
            
            els.resOverlay.classList.add('hidden');
            hidePopup();
            updateDividers(0, 0); // Reset position
            resetHighlights();
            
            els.log.innerHTML = '';
            log(`Init: len1=${len1}, len2=${len2}, totalLeft=${totalLeft}`);
            
            els.btnStep.disabled = false;
            els.btnStep.classList.replace('bg-gray-600', 'bg-green-600');
            els.btnStep.innerHTML = '<i class="fa-solid fa-arrow-right-to-bracket mr-1"></i> 单步执行 (F10)';

            updateVarsDisplay();
            updateRangeBar();
            highlightCode('code-0');
        }

        // --- Step Logic (The Debugger Core) ---
        function step() {
            switch (currentState) {
                case State.LOOP_CHECK:
                    highlightCode('code-1');
                    if (low <= high) {
                        log(`Loop Check: low(${low}) <= high(${high}). Continue.`);
                        currentState = State.CALC_PARTITION;
                    } else {
                        log("Error: Loop finished without finding median.");
                        els.btnStep.disabled = true;
                    }
                    break;

                case State.CALC_PARTITION:
                    // Code: i = ... j = ...
                    i = Math.floor((low + high) / 2);
                    j = totalLeft - i;
                    
                    updateVarsDisplay(); // Show i, j
                    updateDividers(i, j); // Animate dividers
                    
                    highlightCode(['code-2', 'code-3']);
                    log(`Partition: i=${i}, j=${j}`);
                    currentState = State.GET_BOUNDARIES;
                    break;

                case State.GET_BOUNDARIES:
                    // Code: L1, R1...
                    // REPAIR: Use len1/len2 instead of m/n
                    L1 = (i === 0) ? -Infinity : nums1[i-1];
                    R1 = (i === len1) ? Infinity : nums1[i];
                    L2 = (j === 0) ? -Infinity : nums2[j-1];
                    R2 = (j === len2) ? Infinity : nums2[j];

                    updateVarsDisplay(); // Show L1..R2
                    
                    // Highlight the 4 specific cells
                    highlightCell('c1', i-1, 'hl-val hl-left');
                    highlightCell('c1', i, 'hl-val hl-right');
                    highlightCell('c2', j-1, 'hl-val hl-left');
                    highlightCell('c2', j, 'hl-val hl-right');

                    highlightCode(['code-6', 'code-7']);
                    log(`Boundaries: L1=${fmt(L1)}, R1=${fmt(R1)}, L2=${fmt(L2)}, R2=${fmt(R2)}`);
                    currentState = State.CHECK_1;
                    break;

                case State.CHECK_1:
                    highlightCode('code-10');
                    showPopup("L1", "R2", L1, R2);
                    
                    if (L1 > R2) {
                        // Fail condition 1
                        updatePopupResult(false, `${fmt(L1)} > ${fmt(R2)} (Too Big)`);
                        log(`Check 1: L1 > R2. Nums1 partition too far right.`);
                        // Prepare to branch
                        currentState = State.DECISION; // We know decision is high = i - 1
                    } else {
                        updatePopupResult(true, "OK");
                        log(`Check 1: L1 <= R2. OK.`);
                        // Must check next condition in next step
                        currentState = State.CHECK_2; 
                    }
                    break;

                case State.CHECK_2:
                    if (currentState === State.DECISION) break; // Already decided in Check 1

                    highlightCode(['code-13']);
                    showPopup("L2", "R1", L2, R1);

                    if (L2 > R1) {
                        // Fail condition 2
                        updatePopupResult(false, `${fmt(L2)} > ${fmt(R1)} (Too Big)`);
                        log(`Check 2: L2 > R1. Nums1 partition too far left.`);
                        currentState = State.DECISION;
                    } else {
                        updatePopupResult(true, "OK");
                        log(`Check 2: L2 <= R1. OK.`);
                        // Both OK -> Found
                        currentState = State.FOUND;
                    }
                    break;

                case State.DECISION:
                    hidePopup();
                    resetHighlights();
                    
                    if (L1 > R2) {
                        highlightCode('code-11');
                        high = i - 1;
                        log(`Decision: high = i - 1 = ${high}`);
                    } else if (L2 > R1) {
                        highlightCode('code-14');
                        low = i + 1;
                        log(`Decision: low = i + 1 = ${low}`);
                    }
                    
                    updateVarsDisplay();
                    updateRangeBar(); // Visual shrink
                    currentState = State.LOOP_CHECK; // Back to start
                    break;

                case State.FOUND:
                    hidePopup();
                    highlightCode('code-18');
                    showResult();
                    els.btnStep.disabled = true;
                    els.btnStep.innerHTML = '<i class="fa-solid fa-check mr-1"></i> 完成';
                    log("Found! Algorithm Terminated.");
                    break;
            }
        }

        // --- Visual Helpers ---

        function updateDividers(px, py) {
            // Each cell is 45px + 4px margin = 49px approx
            // We use DOM offset to be precise
            moveDivider(els.dN1, els.cN1, px, len1);
            moveDivider(els.dN2, els.cN2, py, len2);
        }

        function moveDivider(div, container, idx, total) {
            let left = 0;
            if (idx === 0) left = 16; // padding-left
            else if (idx === total) {
                const last = container.lastElementChild;
                left = last.offsetLeft + last.offsetWidth + 2;
            } else {
                const el = container.children[idx];
                left = el.offsetLeft - 2;
            }
            div.style.left = `${left}px`;
        }

        function highlightCell(prefix, idx, classes) {
            if (idx < 0) return; // boundary
            const el = document.getElementById(`${prefix}-${idx}`);
            if (el) el.className = `array-cell ${classes}`;
        }

        function resetHighlights() {
            document.querySelectorAll('.array-cell').forEach(el => {
                el.className = 'array-cell text-gray-500 border-gray-700 bg-[#252526]';
            });
        }

        function highlightCode(ids) {
            // Clear old
            document.querySelectorAll('.code-active').forEach(el => el.classList.remove('code-active'));
            // Set new
            if (Array.isArray(ids)) {
                ids.forEach(id => document.getElementById(id)?.classList.add('code-active'));
            } else {
                document.getElementById(ids)?.classList.add('code-active');
            }
        }

        function showPopup(label1, label2, val1, val2) {
            els.cmpLeft.innerText = `${label1} (${fmt(val1)})`;
            els.cmpRight.innerText = `${label2} (${fmt(val2)})`;
            els.cmpRes.innerText = "?";
            els.cmpRes.className = "text-sm font-bold text-gray-400";
            
            els.cmpPopup.classList.remove('hidden');
            // Trigger reflow for transition
            void els.cmpPopup.offsetWidth; 
            els.cmpPopup.classList.remove('opacity-0');
        }

        function updatePopupResult(pass, msg) {
            els.cmpRes.innerText = msg;
            els.cmpRes.className = pass ? "text-sm font-bold text-green-400" : "text-sm font-bold text-red-400";
        }

        function hidePopup() {
            els.cmpPopup.classList.add('opacity-0');
            setTimeout(() => els.cmpPopup.classList.add('hidden'), 300);
        }

        function updateRangeBar() {
            // Visual range on Nums 1
            if (len1 === 0) return;
            const l = Math.max(0, low);
            const h = Math.min(len1, high);
            
            // Calculate pixel positions
            // Start of container
            const base = els.cN1.getBoundingClientRect().left; 
            
            // Find start pos
            const startPx = getGapPos(els.cN1, l, len1);
            const endPx = getGapPos(els.cN1, h, len1);
            
            els.rangeBar.style.left = `${startPx}px`;
            els.rangeBar.style.width = `${Math.max(4, endPx - startPx)}px`;
        }

        function getGapPos(container, idx, total) {
            if (idx === 0) return 16; // padding
            if (idx === total) {
                const last = container.lastElementChild;
                return last.offsetLeft + last.offsetWidth + 2 - 16; // relative to padding
            }
            return container.children[idx].offsetLeft - 2 - 16;
        }

        function updateVarsDisplay() {
            els.vLow.innerText = low;
            els.vHigh.innerText = high;
            els.vI.innerText = i;
            els.vJ.innerText = j;
            els.vL1.innerText = fmt(L1);
            els.vR1.innerText = fmt(R1);
            els.vL2.innerText = fmt(L2);
            els.vR2.innerText = fmt(R2);
        }

        function showResult() {
            let med = 0.0;
            let logic = "";
            if ((len1 + len2) % 2 === 0) {
                med = (Math.max(L1, L2) + Math.min(R1, R2)) / 2.0;
                logic = `(max(${fmt(L1)},${fmt(L2)}) + min(${fmt(R1)},${fmt(R2)})) / 2`;
            } else {
                med = Math.max(L1, L2);
                logic = `max(${fmt(L1)}, ${fmt(L2)})`;
            }
            
            document.getElementById('final-calc').innerText = logic;
            document.getElementById('final-val').innerText = med;
            els.resOverlay.classList.remove('hidden');
        }

        // Utils
        function log(msg) {
            const d = document.createElement('div');
            d.innerText = `> ${msg}`;
            els.log.appendChild(d);
            els.log.scrollTop = els.log.scrollHeight;
        }
        function fmt(v) {
            if (v === Infinity) return "∞";
            if (v === -Infinity) return "-∞";
            return v !== undefined ? v : "-";
        }

        // Start
        init();

    </script>
</body>
</html>