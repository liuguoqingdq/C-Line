**POSIX AIO（异步 I/O）接口**，头文件 `<aio.h>`。它们提供的是“**提交请求→稍后取完成结果**”的完成通知型模型（completion-based）。

> 先纠正一个容易混淆点：**这些函数在 Linux 上通常是库接口**（glibc 提供），不一定每个都对应一个“独立内核系统调用”。实现上可能用内核能力，也可能用用户态线程模拟；但对你写代码来说，这套 API 的用法是固定的。

---

## 1）`struct aiocb` 是什么？（一次异步 I/O 的“请求描述块”）

`aiocb` 可以理解为：**你把这次异步读/写需要的所有信息都填在这里**，然后交给 `aio_read/aio_write` 提交。

你截图里常用字段含义（按“你必须理解的”）：

- `int aio_fildes;`  
    目标文件描述符（`open()` 得到的 fd）。
    
- `volatile void *aio_buf;`  
    用户缓冲区地址（读：写入这里；写：从这里读出）。  
    **关键约束：在 I/O 完成之前，这块内存必须一直有效，不能释放/复用。**
    
- `size_t aio_nbytes;`  
    本次读/写的字节数。
    
- `struct sigevent aio_sigevent;`  
    完成通知方式（可选）：
    
    - `SIGEV_NONE`：不通知，你自己轮询/等待
        
    - `SIGEV_SIGNAL`：完成后给进程发信号
        
    - `SIGEV_THREAD`：完成后回调一个线程函数（glibc 帮你起）
        
- `int aio_reqprio;`  
    请求优先级偏移（多数场景用 0，别指望它在各系统上都有明显效果）。
    

> 你这张图没截到但实际很常用的字段：`aio_offset`（文件偏移）。做文件随机读写时必须填它；否则很多实现会按“当前文件偏移”处理，容易和你预期不一致。

---

## 2）各函数分别解决什么问题、怎么用

### 2.1 `int aio_read(struct aiocb *cb);`

**提交一次异步读**。成功通常返回 0；失败返回 -1 并置 `errno`。  
提交后**不会**立刻拿到数据，数据稍后才会写进 `cb->aio_buf`。

### 2.2 `int aio_write(struct aiocb *cb);`

**提交一次异步写**。类似 `aio_read`。

---

### 2.3 `int aio_error(const struct aiocb *cb);`

**查询这次异步 I/O 的状态**，返回值很关键：

- `EINPROGRESS`：还没完成
    
- `0`：完成且无错误（注意：这只是“无错误”，不等于写入字节数）
    
- 其他 errno（如 `EIO`）：表示该请求失败原因
    

---

### 2.4 `ssize_t aio_return(struct aiocb *cb);`

**取回最终结果**（返回本次实际读/写的字节数；失败通常是 -1）。  
**只能在 aio_error 不再是 EINPROGRESS 之后调用**，而且一般要求**只调用一次**（语义上是“回收结果”）。

---

### 2.5 `int aio_suspend(const struct aiocb *const list[], int nent, const struct timespec *timeout);`

**等待**：阻塞直到 `list` 里**至少一个请求完成**或超时。  
这是“比轮询 aio_error 更省 CPU”的方式。

- `timeout = NULL`：一直等
    
- 非 NULL：最多等到超时（超时会返回 -1 并置 `errno=EAGAIN` 或 `ETIMEDOUT`，具体看实现）
    

---

### 2.6 `int aio_cancel(int fd, struct aiocb *cb);`

尝试取消请求（可能取消成功，也可能已经在执行无法取消）。典型返回：

- `AIO_CANCELED`：取消成功
    
- `AIO_NOTCANCELED`：有些/全部没法取消
    
- `AIO_ALLDONE`：请求已经全部完成了（没必要取消）
    

---

### 2.7 `int aio_fsync(int op, struct aiocb *cb);`

提交一个“异步刷盘”请求（把该文件相关数据刷到存储）。  
`op` 常见值（按 POSIX 约定）：

- `O_SYNC`：更强（数据+必要元数据）
    
- `O_DSYNC`：偏“只保证数据”（更轻）
    

它的完成同样用 `aio_error/aio_return/aio_suspend` 来等。

---